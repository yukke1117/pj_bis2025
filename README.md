# STM32U385 Peripheral Testing & Monitoring System

## 概要

STM32U385RGTxQマイクロコントローラーを使用した包括的な周辺機器テストおよびモニタリングシステムです。内部DAC/ADCループバックテストと外部ADS1299 ADC通信を組み合わせ、LCDディスプレイとUARTシリアル出力の両方で結果を表示します。

## 主な機能

### 🔌 電流測定システム
- **精密電圧生成**: DAC出力による5段階の電圧レベル（100mV〜500mV）
- **リアルタイム電流計算**: (V_adc - 0.5V) / 151kΩ の計算式による電流測定
- **ボタン制御**: ユーザーボタンによる電圧レベル切り替え
- **マルチサンプリング**: ADC測定値の平均化による高精度測定

### 📊 デュアルディスプレイシステム
- **LCD表示**: 176x176ピクセル、4ビットグレースケール
  - 起動時ロゴ表示（3秒間）
  - DAC/ADC電圧値のリアルタイム表示
  - 計算された電流値（μA単位）
  - ADS1299ステータス表示
- **UART出力**: 115200ボーレートでのデバッグ情報出力

### 🏥 ADS1299バイオメディカルADC
- 8チャンネル、24ビット分解能
- EEG/ECG測定用の高精度ADC
- SPI2による完全なレジスタ制御
- チャンネル1のデータ取得実装

## ハードウェア構成

### 開発ボード
- **ボード**: NUCLEO-U385RG-Q
- **MCU**: STM32U385RGTxQ (ARM Cortex-M33)

### ピン配置

#### LCDインターフェース (SPI1)
| 信号名 | ピン | 説明 |
|--------|------|------|
| LCD_CS | PC9 | チップセレクト |
| LCD_DISP | PC10 | ディスプレイ有効化 |
| LCD_EXTCOMIN | PC8 | バックライトPWM (TIM3_CH3) |
| SPI1_SCK | PA5 | クロック |
| SPI1_MOSI | PA7 | データ出力 |

#### ADS1299インターフェース (SPI2)
| 信号名 | ピン | 説明 |
|--------|------|------|
| ADC_CS | PC7 | チップセレクト |
| ADC_RESET | PC6 | ハードウェアリセット |
| ADC_DRDY | PB15 | データレディ信号 |
| SPI2_SCK | PB13 | クロック |
| SPI2_MISO | PB14 | データ入力 |
| SPI2_MOSI | PB15 | データ出力 |

#### その他のペリフェラル
- **UART5**: デバッグシリアル通信
- **DAC1_OUT1**: アナログ出力
- **ADC1**: アナログ入力（OPAMP1経由）
- **OPAMP1/2**: 電圧フォロワー設定

## ソフトウェアアーキテクチャ

### ディレクトリ構造
```
pj_bis2025/
├── Core/
│   ├── Inc/                 # ヘッダファイル
│   │   ├── main.h           # メイン定義とピンマッピング
│   │   ├── lcd.h            # LCDインターフェース
│   │   ├── font8x8_basic.h # フォントデータ
│   │   └── image_logo.h    # ロゴ画像データ
│   └── Src/                 # ソースファイル
│       ├── main.c           # メインアプリケーション
│       ├── lcd.c            # LCD低レベルドライバ
│       ├── lcd_text.c       # テキストレンダリング
│       └── Image.c          # 画像処理
├── Drivers/                 # STM32 HALドライバ
├── Debug/                   # ビルド出力
└── CLAUDE.md               # 開発ガイドライン
```

### データフロー
1. **ユーザー入力**: ボタン押下で電圧レベル変更
2. **DAC出力**: 12ビット分解能で精密電圧生成
3. **OPAMP バッファリング**: 高インピーダンス電圧フォロワー
4. **ADC変換**: 複数サンプルの平均化
5. **電流計算**: マイクロアンペア単位への変換
6. **表示更新**: LCD/UART両方への出力

## ビルドと実行

### 必要な環境
- STM32CubeIDE 1.18.1以降
- GNU Tools for STM32 (v13.3.rel1)
- ST-LINK デバッガー

### ビルド手順
```bash
# Debugビルド
cd Debug
make clean
make all

# またはSTM32CubeIDEから直接ビルド
```

### フラッシュ書き込み
1. NUCLEO-U385RG-QボードをUSBで接続
2. STM32CubeIDEのデバッガーを使用するか、以下のコマンドを実行:
```bash
st-flash write Debug/pj-bis2025.elf 0x08000000
```

### シリアルモニタリング
```bash
# macOS/Linux
screen /dev/tty.usbserial-* 115200

# Windows (PuTTY使用)
# ポート: COMx, ボーレート: 115200
```

## 使用方法

### 基本操作
1. **電源投入**: USBケーブルでボードに電源供給
2. **初期化**: 3秒間のロゴ表示後、システムReady
3. **電圧切り替え**: USERボタンを押すたびに電圧レベルが切り替わる
   - レベル1: 100mV
   - レベル2: 200mV
   - レベル3: 300mV
   - レベル4: 400mV
   - レベル5: 500mV
4. **モニタリング**: LCD画面とシリアル出力で測定値を確認

### LCD表示内容
```
Current Monitor
DAC: xxxmV [n/5]    # 現在のDAC電圧とレベル
ADC: xxxmV          # 測定されたADC電圧
Current: xx.x uA    # 計算された電流値
ADS1299: ID=0xXX    # ADS1299デバイスID
CH1: xxxxxxxx       # チャンネル1データ
```

## トラブルシューティング

### ビルドエラー
- **arm-none-eabi-gcc not found**: GNU Arm Embedded Toolchainをインストール
- **makefile error**: WindowsパスをLinux/macOS用に修正（Debug/makefile内）

### ハードウェア接続
- **シリアル出力なし**: ボーレートが115200に設定されているか確認
- **LCD表示なし**: LCD_DISPピンがHIGHになっているか確認
- **ADS1299通信エラー**: SPI2接続とCS/RESETピンを確認

### 測定値の問題
- **電圧が不安定**: DAC Sample & Holdモードが有効か確認
- **ADC読み取りエラー**: OPAMP1が正しく設定されているか確認

## 開発者向け情報

### コーディング規約
- HAL関数を使用したSTM32標準実装
- エラーハンドリングの徹底
- デバッグ出力の充実

### 拡張可能性
- ADS1299の追加チャンネル有効化
- LCD表示のカスタマイズ
- 追加センサーの統合

## ライセンス

このプロジェクトはSTMicroelectronicsのHALライブラリライセンスに従います。

## 貢献者

- プロジェクト開発者
- STM32 HALライブラリ提供: STMicroelectronics

## 更新履歴

- 2025年1月: DAC電圧安定性の改善
- 2025年1月: 初期リリース

---

詳細な技術情報は[CLAUDE.md](CLAUDE.md)を参照してください。